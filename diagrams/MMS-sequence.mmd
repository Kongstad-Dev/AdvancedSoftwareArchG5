sequenceDiagram
autonumber
participant MMS as Monitoring & Maintenance System (MMS)
participant PMS as Production Mgmt System (PMS/Scheduler)
participant Kafka as Kafka Bus
participant MQTT as MQTT Broker
participant Primary as Primary Machine/Sensor
participant Backup as Backup Machine/Sensor
participant DB as MongoDB (Sensor Data)

%% --- Normal operation: continuous health monitoring ---
loop every 1s health check
  Primary-->>MQTT: status OK + metrics
  MQTT-->>Kafka: status OK + metrics
  Kafka-->>MMS: status OK + metrics
  MMS->>DB: persist(metrics);
end

%% --- Failure detected and switchover ---
alt Primary failure detected [timeout > 3s OR 3 consecutive misses]
  MMS->>DB: getBackupInfo(primaryId)
  DB-->>MMS: backupId, status OK
  MMS->>PMS: notifyFailure(primaryId, backUpId) (gRPC)
  PMS->>Kafka: updateWorkloadConfiguration(backUpId)
  Note over PMS,Backup: Production continues without interruption (target 99.9% uptime)
else Backup not available
  MMS->>DB: getBackupInfo(primaryId)
  DB-->>MMS: Null, status 404
  MMS->>PMS: haltProduction() (gRPC)
  PMS->>Kafka: haltProduction()
  Note over PMS,Backup: Production halted, until manual intervention
end

%% --- Recovery path (optional/hysteresis) ---
opt Primary sensor recovers later [N=5 consecutive healthy checks]
  Primary-->>MQTT: status OK + metrics
  MQTT-->>Kafka: status OK + metrics
  Kafka-->>MMS: status OK + metrics
  MMS->>PMS: notifyRecovery(primaryId) (gRPC)
  PMS->>Kafka: updateWorkloadConfiguration(primaryId)
end